<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
</head>

<body>
    <h1>User profile</h1>

    <!-- User Details Section -->
    <section>
        <h2>User Details</h2>
        <p>Name: John Doe</p> <!-- Replace with actual user details -->
        <p>Account Number: 1234567890</p> <!-- Replace with actual user details -->
    </section>

    <!-- Add a button or link to trigger the popup -->
    <button id="filter-transactions-btn">Filter Transactions</button>

    <!-- Bank Statement Download Button -->
    <section>
        <h2>Download Bank Statement</h2>
        <a href="{% url 'download_bank_statement' %}" class="btn btn-primary">Download Bank Statement</a>
    </section>
    <h2>Send Via Email</h2>
    <button id="send-email-btn">Send Email</button>

    <!-- Transaction Table -->
    <section>
        <h2>Transaction History</h2>
        <table>
            <thead>
                <tr>
                    <th>User Email</th>
                    <th>Date of Transaction</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr>
                    <td>{{ transaction.user_email }}</td>
                    <td>{{ transaction.date_of_transaction }}</td>
                    <td>{{ transaction.amount }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
</body>

</html>

<script>
    document.getElementById('send-email-btn').addEventListener('click', function () {
        // const csrftoken = getCookie('csrftoken');
        // Make an AJAX request to the Django view that sends the email
        fetch('/send_email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
            .then(response => response.json())
            .then(data => {
                // Handle the response data (e.g., show a success message)
                console.log(data);
                alert(data.message); // Show a message to the user
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while sending the email.'); // Show an error message to the user
            });
    });

    // Add an event listener to the filter button to show the filter popup
    document.getElementById('filter-btn').addEventListener('click', function () {
        document.getElementById('filter-popup').style.display = 'block';
    });

    // Add an event listener to the filter submit button
    document.getElementById('filter-submit').addEventListener('click', function () {
        const email = document.getElementById('email').value;
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;

        // Make an AJAX request to the Django view to filter transactions
        fetch('/filter_transactions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token
            },
            body: JSON.stringify({ email, startDate, endDate }),
        })
            .then(response => response.json())
            .then(data => {
                // Handle the response data (e.g., update the transaction table)
                updateTransactionTable(data.transactions);
                document.getElementById('filter-popup').style.display = 'none'; // Hide the popup
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while filtering transactions.');
            });
    });

    // Function to update the transaction table with filtered data
    function updateTransactionTable(transactions) {
        const tableBody = document.getElementById('filtered-transactions');
        tableBody.innerHTML = '';

        transactions.forEach(transaction => {
            const row = tableBody.insertRow();
            const emailCell = row.insertCell(0);
            const dateCell = row.insertCell(1);
            const amountCell = row.insertCell(2);

            emailCell.textContent = transaction.user_email;
            dateCell.textContent = transaction.date_of_transaction;
            amountCell.textContent = transaction.amount;
        });
    }

    // Function to retrieve the CSRF token from cookies
    function getCookie(name) {
        const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return cookieValue ? cookieValue.pop() : '';
    }

</script>